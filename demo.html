<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Demo</title>
</head>

<body>
    <div>
        <div id='insertHere'></div>
        <br>
        <div>

            <textarea name="circult" id="circult" cols="40" rows="5" spellcheck="false">12,9





            </textarea>
            <br>
            <input type="button" id='Generate' onclick="buildMainSVG()" value="Generate">
            <input type="button" id='Submit' onclick="submit()" value="Submit">
        </div>
        <div id='resultlist' style="font-family:monospace;"></div>
        <pre id='postresult' style="font-family:monospace;"></pre>
        <hr>
        <div id='resultlist2' style="font-family:monospace;"></div>
        <p>xsize ysize _ndeep _edeep _max _min _q0x _q0y</p>
        <pre id='formatedGateArray' style="font-family:monospace;"></pre>
    </div>
    <script src="./main.js"></script>
    <script>

function xhrPost(url,data,callback) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function(){
        if(xhr.readyState==4){
            if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304) {
                callback(null,xhr.responseText);
            }else{
                callback([xhr.status,xhr.responseText],null);
            }
        }
    }
    xhr.open('post',url);
    xhr.setRequestHeader('Content-Type','text/plain')
    xhr.send(data);
}

function enablesubmit(params) {
    document.getElementById('Submit').disabled = false
}

function disablesubmit(params) {
    document.getElementById('Submit').disabled = true
}

function submit(params) {
    disablesubmit()
    document.getElementById('postresult').innerHTML='waiting'
    xhrPost('/',JSON.stringify({CInput:window.sd.CInput}),function (err,data) {
        if (err) {
            console.log(err)
            document.getElementById('postresult').innerHTML=err
        } else {
            document.getElementById('postresult').innerHTML=preProcessResult(data)
            processCNFResult()
            processCNFResult(null,1,1)
        }

        enablesubmit()
    })
}

function preProcessResult(resultStr) {
    // 2 paths found
    // shortest length & unbalance: 2,1
    // qubits: 2, 1, 1, 2, 2, 3, 1, 4,
    // start,end: 2 4 3 1
    // ===2
    // 2,1: 2, 1, 1, 2, 2, 3, 1, 4,
    // 2,1: 2, 1, 1, 2, 3, 2, 2, 3, 1, 4,
    try {
        let check={}
        let sd= window.sd
        let last=[]
        let str=resultStr.split('===')[1]
        let lines=str.split('\n')
        for (let ii = 1; ii <= ~~lines[0]; ii++) {
            let a=eval('['+lines[ii].split(':')[1]+']')
            let b=a.map((v,i,a)=>{ return {x:v-1,y:a[i+1]-1}}).filter((v,i)=>i%2==0).map(v=>sd.getxy(v).qi)
            if (check[JSON.stringify(b)]==null) {
                check[JSON.stringify(b)]=1
                last.push(b)
            }
        }
        window.lastResult=last
    } catch (error) {
    }
    return resultStr
}

function processCNFResult(result,showall,target) {
    if (result==null) {
        result=window.lastResult
    }
    target=target?'resultlist2':'resultlist'

    let list=[]
    for (let index = 0; index < result.length; index++) {
        const removeList = result[index];
        list.push(window.sd.copy().setSplit(removeList))
    }

    if(!showall)list=list.slice(0,1)
    let viewList=list.map(v=>new window.view.constructor().init().importData(v).generateBaseSVG().generateSVGCSS().generateSVG())

    document.getElementById(target).innerHTML=viewList.map(v=>v.SVG).join('\n<br>\n')
}


    </script>

</body>

</html>