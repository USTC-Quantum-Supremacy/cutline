<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Demo</title>
    <style id="patternColor">
        
    </style>
</head>

<body>
    <div>
        <div id='insertHere'></div>
        <br>
        <div>

            <textarea name="circult" id="circult" cols="40" rows="6" spellcheck="false">12,11



0.0016,0.0062,0.038,20

            </textarea>
            <br>
            <input type="button" id='Generate' onclick="buildMainSVG()" value="Generate">
            <select id="isusingwegde">
                <option value="true">Min(cut length)</option>
                <option value="false">Min(cut length *2 - wegde)</option>
            </select>
            <input type="button" id='Submit' onclick="submit()" value="Submit">
            <br>
            <input type="button" id='reRenderResult' onclick="reRenderResult()" value="ReRenderResult">
            <select id="patternSelect" onchange="changePatten()">
                <option value="None">None</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="G">G</option>
                <option value="H">H</option>
            </select>
            <select id="patternSelect2" onchange="changePatten()">
                <option value="None">None</option>
                <option value="C">C</option>
                <option value="D">D</option>
                <option value="E">E</option>
                <option value="F">F</option>
            </select>
        </div>
        <div id='resultlist' style="font-family:monospace;"></div>
        <pre id='postresult' style="font-family:monospace;"></pre>
        <hr>
        <div id='resultlist2' style="font-family:monospace;"></div>
        <p>xsize ysize _ndeep _edeep _max _min _q0x _q0y</p>
        <pre id='formatedGateArray' style="font-family:monospace;"></pre>
    </div>
    <script src="./main.js"></script>
    <script>

function xhrPost(url,data,callback) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function(){
        if(xhr.readyState==4){
            if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304) {
                callback(null,xhr.responseText);
            }else{
                callback([xhr.status,xhr.responseText],null);
            }
        }
    }
    xhr.open('post',url);
    xhr.setRequestHeader('Content-Type','text/plain')
    xhr.send(data);
}

function enablesubmit(params) {
    document.getElementById('Submit').disabled = false
}

function disablesubmit(params) {
    document.getElementById('Submit').disabled = true
}

function submit(params) {
    disablesubmit()
    document.getElementById('postresult').innerHTML='waiting'
    xhrPost('/',JSON.stringify({CInput:window.sd.CInput,prune:eval(isusingwegde.value)}),function (err,data) {
        if (err) {
            console.log(err)
            document.getElementById('postresult').innerHTML=err
        } else {
            document.getElementById('postresult').innerHTML=preProcessResult(data)
            reRenderResult()
        }

        enablesubmit()
    })
}

function preProcessResult(resultStr) {
    // 2 paths found
    // shortest length & unbalance: 2,1
    // qubits: 2, 1, 1, 2, 2, 3, 1, 4,
    // start,end: 2 4 3 1
    // ===2
    // 2,1: 2, 1, 1, 2, 2, 3, 1, 4,
    // 2,1: 2, 1, 1, 2, 3, 2, 2, 3, 1, 4,
    try {
        let check={}
        let sd= window.sd
        let last=[]
        let str=resultStr.split('===')[1]
        let lines=str.split('\n')
        for (let ii = 1; ii <= ~~lines[0]; ii++) {
            let a=eval('['+lines[ii].split(':')[1]+']')
            let b=a.map((v,i,a)=>{ return {x:v-1,y:a[i+1]-1}}).filter((v,i)=>i%2==0).map(v=>sd.getxy(v).qi)
            if (check[JSON.stringify(b)]==null) {
                check[JSON.stringify(b)]=1
                last.push(b)
            }
        }
        window.lastResult=last
    } catch (error) {
    }
    return resultStr
}

function processCNFResult(result,showall,target) {
    if (result==null) {
        result=window.lastResult
    }
    target=target?'resultlist2':'resultlist'


    let list=[]
    for (let index = 0; index < result.length; index++) {
        const removeList = result[index];
        list.push(window.sd.copy().setSplit(removeList))
    }
    window.slist=list
    let cal = document.getElementById('circult').value.split('\n')[4]
    if (cal && !showall) {
        cal=eval('['+cal+']')
        let e1=cal[0],e2=cal[1],er=cal[2],d=cal[3];
        list.map(v=>v.calExpectation({e1,e2,er,d}))
    }
    let wedgestr=''
    if(!showall){
        list.map(v=>v.calCutLengthWithWedge())
        let pv=list[0].circles.map((ps,ii,arr)=>{
            let pattern = ps[0]
            let mini=list.map(v=>v.wegde[pattern].length).reduce((iMax, x, i, arr) => x < arr[iMax] ? i : iMax, 0)
            return [list[mini].wegde[pattern].length,mini,pattern]
        })
        let pi=pv.map(v=>v[0]).reduce((iMax, x, i, arr) => x > arr[iMax] ? i : iMax, 0)
        list=[list[pv[pi][1]]]
        window.pv=pv
        window.ssd=list[0]
        window.spattern=pv[pi][2]
        wedgestr='<br>'+JSON.stringify(window.ssd.wegde[window.spattern])+'<br>'
        console.log(window.ssd)
        console.log(window.ssd.wegde[window.spattern])
        console.log(window.pv)
    }
    let viewList=list.slice(0,500).map(v=>new window.view.constructor().init().importData(v).generateBaseSVG().generateSVGCSS().generateSVG())

    document.getElementById(target).innerHTML=viewList.map(v=>v.SVG+wedgestr+v.getExpectation().expectation).join('\n<br>\n')
}

function reRenderResult(params) {
    processCNFResult()
    processCNFResult(null,1,1)
}

function changePatten(params) {
    patternColor.innerHTML=`
        #insertHere .qline.pattern${patternSelect.value} {
            stroke: blue;
            stroke-width: 20;
        }

        #insertHere .qline.pattern${patternSelect2.value} {
            stroke: green;
            stroke-width: 20;
        }
    `
}
    </script>

</body>

</html>