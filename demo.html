<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Demo</title>
</head>

<body>
    <div>
        <div id='insertHere'></div>
        <br>
        <div>

            <textarea name="circult" id="circult" cols="40" rows="5" spellcheck="false">12,9



            </textarea>
            <br>
            <input type="button" id='Generate' onclick="buildMainSVG()" value="Generate">
            <input type="button" id='Submit' onclick="submit()" value="Submit">
        </div>
        <pre id='postresult' style="font-family:monospace;"></pre>
        <div id='resultlist' style="font-family:monospace;"></div>
        <hr>
        <div id='resultlist2' style="font-family:monospace;"></div>
        <p>xsize ysize _ndeep _edeep _max _min _q0x _q0y</p>
        <pre id='formatedGateArray' style="font-family:monospace;"></pre>
    </div>
    <script src="./main.js"></script>
    <script>

function xhrPost(url,data,callback) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function(){
        if(xhr.readyState==4){
            if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304) {
                callback(null,xhr.responseText);
            }else{
                callback([xhr.status,xhr.responseText],null);
            }
        }
    }
    xhr.open('post',url);
    xhr.setRequestHeader('Content-Type','text/plain')
    xhr.send(data);
}

function enablesubmit(params) {
    document.getElementById('Submit').disabled = false
}

function disablesubmit(params) {
    document.getElementById('Submit').disabled = true
}

function submit(params) {
    disablesubmit()
    document.getElementById('postresult').innerHTML='waiting'
    xhrPost('/',JSON.stringify({CInput:window.sd.CInput}),function (err,data) {
        if (err) {
            console.log(err)
            document.getElementById('postresult').innerHTML=err
        } else {
            document.getElementById('postresult').innerHTML=preProcessResult(data)
            processCNFResult()
            processCNFResult(null,1,1)
        }

        enablesubmit()
    })
}

function preProcessResult(resultStr) {
    let sd= window.sd
    let rmap={}
    for (const key in sd.maxAreaMap) {
        if (sd.maxAreaMap.hasOwnProperty(key)) {
            const value = sd.maxAreaMap[key];
            rmap[value]=key
        }
    }
    let lines = resultStr.split('\n')
    let last=[]
    for (let index = 0; index < lines.length; index++) {
        const line = lines[index];
        if (/^(\s*?\d+\s*)+$/.exec(line)) {
            last=[]
            lines[index]=line.replace(/\d+/g,v=>{last.push(~~rmap[~~v]);return last.slice(-1)[0]})
        }
    }
    window.lastResult=last
    return lines.join('\n')
}

function processCNFResult(result,showall,target) {
    if (result==null) {
        result=window.lastResult
    }
    target=target?'resultlist2':'resultlist'

    let list=[]
    for (let index = 1; index <= result.length; index++) {
        const removeList = result.slice(0,index);
        list.push(window.sd.copy().setSplit(removeList))
    }

    let maxEageCount=Math.max.apply(null,list.map(v=>v.splitEdges.length))
    if(!showall)list=list.filter(v=>v.splitEdges.length===maxEageCount)
    let viewList=list.map(v=>new window.view.constructor().init().importData(v).generateBaseSVG().generateSVGCSS().generateSVG())

    document.getElementById(target).innerHTML=maxEageCount+'\n<br>\n'+viewList.map(v=>v.SVG).join('\n<br>\n')
}


    </script>

</body>

</html>